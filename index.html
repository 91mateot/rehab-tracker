<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Snowboard Rehab Tracker</title>
  <!-- Bootstrap 5 (CoreUI-like look using Bootstrap utilities) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --sidebar-width: 260px;
    }
    body { background: #0f172a; color: #e2e8f0; }
    .sidebar { width: var(--sidebar-width); background: #111827; position: fixed; inset: 0 auto 0 0; padding: 1rem; }
    .brand { font-weight: 700; letter-spacing: .5px; }
    .content { margin-left: var(--sidebar-width); padding: 1.25rem; }
    .card { background: #111827; border: 1px solid #1f2937; }
    .form-control, .form-select { background: #0b1220; border-color: #233147; color: #e2e8f0; }
    .form-control::placeholder { color: #94a3b8; }
    .nav-link { color: #e2e8f0; }
    .nav-link.active { background: #0b1220 !important; color: #f8fafc !important; border-color: #334155 !important; }
    .badge-soft { background: rgba(148,163,184,.15); color: #cbd5e1; }
    .table { color: #e2e8f0; }
    .table > :not(caption) > * > * { background: transparent; }
    a { color: #60a5fa; }
    a:hover { color: #93c5fd; }
    .footer { color: #94a3b8; font-size: .875rem; }
    @media (max-width: 991px){
      .sidebar { position: static; width: 100%; }
      .content { margin-left: 0; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar d-flex flex-column gap-3">
    <div class="d-flex align-items-center gap-2">
      <i class="bi bi-activity text-info fs-4"></i>
      <span class="brand">Snowboard Rehab</span>
    </div>
    <hr class="border-secondary"/>
    <nav class="nav nav-pills flex-column" id="nav">
      <a class="nav-link active" href="#/log"><i class="bi bi-pencil-square me-2"></i>Log Entry</a>
      <a class="nav-link" href="#/trends"><i class="bi bi-graph-up me-2"></i>Trends</a>
      <a class="nav-link" href="#/data"><i class="bi bi-table me-2"></i>Data</a>
      <a class="nav-link" href="#/settings"><i class="bi bi-gear me-2"></i>Settings</a>
      <a class="nav-link" href="#/about"><i class="bi bi-info-circle me-2"></i>About</a>
      <a class="nav-link" href="#/plan"><i class="bi bi-journal-richtext me-2"></i>Plan & Packet</a>
    </nav>
    <div class="mt-auto footer">
      <div>CoreUI‑style • Bootstrap 5 • Chart.js</div>
      <div class="small">Local‑only by default. Optional CSV import.</div>
    </div>
  </aside>

  <!-- Main content -->
  <main class="content">
    <div id="view-log" class="view">
      <div class="row g-3">
        <div class="col-12 col-xl-8">
          <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="m-0">Session Log</h5>
              <span class="badge badge-soft"><i class="bi bi-clock me-1"></i>Today: <span id="todayStr"></span></span>
            </div>
            <form id="logForm" class="row g-3">
              <div class="col-12 col-sm-6">
                <label class="form-label">Date</label>
                <input type="date" class="form-control" id="date" required>
              </div>
              <div class="col-12 col-sm-6">
                <label class="form-label">Session Type</label>
                <select id="sessionType" class="form-select" required>
                  <option value="Mobility/Core">Mobility/Core</option>
                  <option value="Lower-Body Strength">Lower-Body Strength</option>
                  <option value="Active Recovery">Active Recovery</option>
                  <option value="Upper-Body + Trunk">Upper-Body + Trunk</option>
                  <option value="Power/Balance/Endurance">Power/Balance/Endurance</option>
                </select>
              </div>
              <div class="col-12 col-sm-4">
                <label class="form-label">Duration (min)</label>
                <input type="number" class="form-control" id="duration" min="0" step="1" placeholder="60" required>
              </div>
              <div class="col-12">
                <div class="row g-3">
                  <div class="col-12 col-lg-4">
                    <div class="card p-3 h-100">
                      <h6>Low‑Back Pain (0–10)</h6>
                      <div class="row g-2">
                        <div class="col"><input id="lbBefore" type="number" min="0" max="10" class="form-control" placeholder="Before"></div>
                        <div class="col"><input id="lbDuring" type="number" min="0" max="10" class="form-control" placeholder="During"></div>
                        <div class="col"><input id="lbAfter" type="number" min="0" max="10" class="form-control" placeholder="After"></div>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 col-lg-4">
                    <div class="card p-3 h-100">
                      <h6>Right Leg/Glute/Hamstring (0–10)</h6>
                      <div class="row g-2">
                        <div class="col"><input id="legBefore" type="number" min="0" max="10" class="form-control" placeholder="Before"></div>
                        <div class="col"><input id="legDuring" type="number" min="0" max="10" class="form-control" placeholder="During"></div>
                        <div class="col"><input id="legAfter" type="number" min="0" max="10" class="form-control" placeholder="After"></div>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 col-lg-4">
                    <div class="card p-3 h-100">
                      <h6>Sitting Tolerance</h6>
                      <div class="mb-2">
                        <select id="surface" class="form-select">
                          <option value="Soft couch">Soft couch</option>
                          <option value="Firm chair">Firm chair</option>
                          <option value="Car seat">Car seat</option>
                          <option value="Other">Other</option>
                        </select>
                      </div>
                      <input id="sitMinutes" type="number" min="0" step="1" class="form-control" placeholder="Minutes before discomfort" />
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-12">
                <label class="form-label">Workout Completion</label>
                <select id="completed" class="form-select">
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                  <option value="Modified">Modified</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">Notes</label>
                <textarea id="notes" class="form-control" rows="3" placeholder="What felt good? What aggravated? Any concerns?"></textarea>
              </div>
              <div class="col-12 d-flex gap-2">
                <button class="btn btn-primary" type="submit"><i class="bi bi-save me-1"></i>Save Entry</button>
                <button class="btn btn-outline-light" type="button" id="exportCsv"><i class="bi bi-filetype-csv me-1"></i>Export CSV</button>
                <button class="btn btn-outline-warning ms-auto" type="button" id="clearAll"><i class="bi bi-trash3 me-1"></i>Clear All (local)</button>
              </div>
            </form>
          </div>
        </div>
        <div class="col-12 col-xl-4">
          <div class="card p-3 mb-3">
            <h6 class="mb-2">Quick Stats</h6>
            <div id="quickStats" class="small text-secondary">No data yet.</div>
          </div>
          <div class="card p-3">
            <h6 class="mb-2">CSV / Google Sheet Import</h6>
            <p class="small text-secondary mb-2">Paste a public CSV URL (e.g., Google Sheet → File → Publish to the web → CSV) and click Import. Local entries will merge (dedupe by date+type).</p>
            <input id="csvUrl" class="form-control mb-2" placeholder="https://.../your.csv" />
            <div class="d-flex gap-2">
              <button id="importCsv" class="btn btn-outline-info"><i class="bi bi-cloud-arrow-down me-1"></i>Import CSV</button>
              <button id="resetCsv" class="btn btn-outline-secondary"><i class="bi bi-arrow-repeat me-1"></i>Reset Source</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="view-trends" class="view d-none">
      <div class="row g-3">
        <div class="col-12 col-xl-4">
          <div class="card p-3">
            <h6 class="mb-2">Back Pain (after session)</h6>
            <canvas id="chartBack"></canvas>
          </div>
        </div>
        <div class="col-12 col-xl-4">
          <div class="card p-3">
            <h6 class="mb-2">Right Leg/Glute/Ham (after session)</h6>
            <canvas id="chartLeg"></canvas>
          </div>
        </div>
        <div class="col-12 col-xl-4">
          <div class="card p-3">
            <h6 class="mb-2">Sitting Tolerance (minutes)</h6>
            <canvas id="chartSit"></canvas>
          </div>
        </div>
      </div>
      <div class="row g-3 mt-1">
        <div class="col-12">
          <div class="card p-3">
            <h6 class="mb-2">Workout Completion Rate</h6>
            <canvas id="chartCompletion"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div id="view-data" class="view d-none">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="m-0">Entries (local + imported)</h6>
          <div>
            <button id="downloadJson" class="btn btn-outline-light btn-sm"><i class="bi bi-file-earmark-arrow-down me-1"></i>Download JSON</button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-borderless align-middle" id="dataTable">
            <thead>
              <tr class="text-secondary">
                <th>Date</th><th>Type</th><th>Dur</th>
                <th>LB Before</th><th>LB During</th><th>LB After</th>
                <th>Leg Before</th><th>Leg During</th><th>Leg After</th>
                <th>Surface</th><th>Sit min</th><th>Completed</th><th>Notes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="view-settings" class="view d-none">
      <div class="card p-3">
        <h6 class="mb-2">Settings</h6>
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label">Pain Alert Threshold (after session)</label>
            <input id="thPain" type="number" min="0" max="10" step="1" class="form-control" placeholder="4" />
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">Min Target Sitting Tolerance (min)</label>
            <input id="thSit" type="number" min="0" step="1" class="form-control" placeholder="20" />
          </div>
          <div class="col-12">
            <button id="saveSettings" class="btn btn-primary"><i class="bi bi-check2-circle me-1"></i>Save Settings</button>
            <button id="resetSettings" class="btn btn-outline-secondary ms-2"><i class="bi bi-arrow-counterclockwise me-1"></i>Reset</button>
          </div>
        </div>
      </div>
      <div class="alert alert-warning mt-3" role="alert">
        <i class="bi bi-shield-lock me-1"></i> Note: This demo stores entries in your browser (localStorage). To drive the charts from a Google Sheet instead, paste a public CSV URL in <em>Log Entry → CSV / Google Sheet Import</em>.
      </div>
    </div>

    <div id="view-about" class="view d-none">
      <div class="card p-3">
        <h6>About</h6>
        <p class="text-secondary">This is a CoreUI‑style Bootstrap 5 dashboard tailored for post‑microdiscectomy rehab tracking and snowboard preparation. It supports chat‑logged entries (which you can copy here) and optional CSV import from Google Sheets. Built with accessibility and mobile use in mind.</p>
        <ul class="text-secondary small">
          <li>Fields tracked: date, session type, duration, low‑back pain (before/during/after), right leg/glute/hamstring symptoms (before/during/after), sitting tolerance (surface & minutes), completion, notes.</li>
          <li>Charts: Back pain (after), Leg symptoms (after), Sitting tolerance minutes, Completion rate.</li>
          <li>Data: Stored locally in your browser; export CSV/JSON anytime.</li>
        </ul>
      </div>
    </div>
      <div id=\"view-plan\" class=\"view d-none\">
      <div class=\"row g-3\">
        <div class=\"col-12 col-xl-8\">
          <div class=\"card p-3\">
            <h5 class=\"mb-2\">Snowboard Recovery + Performance Plan</h5>
            <p class=\"text-secondary small mb-3\">Narrative sessions tailored for post L4/L5 microdiscectomy and return to all-mountain snowboarding. Use this as your day-by-day guide. (You can also attach a PDF link below.)</p>

            <div class=\"accordion\" id=\"planAccordion\">
              <div class=\"accordion-item\">
                <h2 class=\"accordion-header\" id=\"h1\"><button class=\"accordion-button\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#c1\">Day 1 — Mobility + Core Stabilization</button></h2>
                <div id=\"c1\" class=\"accordion-collapse collapse show\" data-bs-parent=\"#planAccordion\">
                  <div class=\"accordion-body\">
                    <strong>Purpose:</strong> Reset stiffness, reinforce neutral lumbar control, prep tissues.
                    <ul>
                      <li><em>Warm-up:</em> 5–10 min easy walk/bike focusing on tall posture.</li>
                      <li><em>Mobility:</em> Kneeling hip flexor stretch 2×30s/side; Hamstring stretch 2×30s/side; Thoracic rotations 2×8/side.</li>
                      <li><em>Core:</em> Dead bug 3×10–12; Bird-dog 3×8–10/side; Front plank 3×30–45s; Side plank 2×20–30s/side.</li>
                      <li><em>Nerve glides:</em> Gentle sciatic sliders (pain-free range) 2×10/side.</li>
                      <li><em>Cool-down:</em> Light stretch; diaphragmatic breathing.</li>
                    </ul>
                    <div class=\"small text-secondary\">Cues: rib cage stacked over pelvis; avoid end-range lumbar flexion.</div>
                  </div>
                </div>
              </div>
              <div class=\"accordion-item\">
                <h2 class=\"accordion-header\" id=\"h2\"><button class=\"accordion-button collapsed\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#c2\">Day 2 — Lower-Body Strength (Glute/Ham emphasis)</button></h2>
                <div id=\"c2\" class=\"accordion-collapse collapse\" data-bs-parent=\"#planAccordion\">
                  <div class=\"accordion-body\">
                    <strong>Purpose:</strong> Build hip-dominant strength with minimal lumbar load.
                    <ul>
                      <li>Glute bridge 3×12–15</li>
                      <li>Split squat (BW or light DBs) 3×8–10/leg</li>
                      <li>DB Romanian deadlift (light–moderate) 3×8–10 — hinge at hips, spine neutral</li>
                      <li>Step-ups 3×8/leg</li>
                      <li>Hamstring curl (machine/Swiss ball) 3×10–12</li>
                      <li>Pallof press 2–3×8/side</li>
                    </ul>
                    <div class=\"small text-secondary\">Progress load only if symptoms stay ≤2/10 for 24–48h post-session.</div>
                  </div>
                </div>
              </div>
              <div class=\"accordion-item\">
                <h2 class=\"accordion-header\" id=\"h3\"><button class=\"accordion-button collapsed\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#c3\">Day 3 — Active Recovery + Sitting Tolerance</button></h2>
                <div id=\"c3\" class=\"accordion-collapse collapse\" data-bs-parent=\"#planAccordion\">
                  <div class=\"accordion-body\">
                    <ul>
                      <li>20–30 min easy walk.</li>
                      <li>Posture practice: lumbar roll, hips slightly higher than knees; micro-break every 20 min.</li>
                      <li>Seated tall-spine holds 2–3×1 min; hip-hinge practice 2×10.</li>
                      <li>SMR: glutes/hamstrings as tolerated.</li>
                    </ul>
                    <div class=\"small text-secondary\">Goal: add 2–3 min to comfortable sitting time each week (esp. soft couch).</div>
                  </div>
                </div>
              </div>
              <div class=\"accordion-item\">
                <h2 class=\"accordion-header\" id=\"h4\"><button class=\"accordion-button collapsed\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#c4\">Day 4 — Upper-Body + Trunk Rotation (controlled)</button></h2>
                <div id=\"c4\" class=\"accordion-collapse collapse\" data-bs-parent=\"#planAccordion\">
                  <div class=\"accordion-body\">
                    <ul>
                      <li>DB bench press 3×8–12</li>
                      <li>Lat pulldown or row 3×8–12</li>
                      <li>DB shoulder press 3×8–10</li>
                      <li>Push-ups 3×AMRAP (form-quality)</li>
                      <li>Half-kneeling chop 3×8/side; light Russian twists 2–3×10–12/side</li>
                      <li>Plank with alternating reach 2×20–30s</li>
                    </ul>
                    <div class=\"small text-secondary\">Cues: rotate through thoracic spine/hips; keep lumbar neutral.</div>
                  </div>
                </div>
              </div>
              <div class=\"accordion-item\">
                <h2 class=\"accordion-header\" id=\"h5\"><button class=\"accordion-button collapsed\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#c5\">Day 5 — Power • Balance • Endurance (Snowboard‑prep)</button></h2>
                <div id=\"c5\" class=\"accordion-collapse collapse\" data-bs-parent=\"#planAccordion\">
                  <div class=\"accordion-body\">
                    <ul>
                      <li>Single‑leg RDL (BW/light DB) 3×6–8/leg</li>
                      <li>Lateral hops (soft landings) 3×10</li>
                      <li>Optional small jumps 3×5–8 (only if symptom‑free)</li>
                      <li>Balance pad/BOSU single‑leg stance 2×30s/leg with slight knee bend</li>
                      <li>10–15 min continuous cardio (elliptical/bike/jog) maintaining neutral spine</li>
                    </ul>
                    <div class=\"small text-secondary\">Goal: smooth landings, hip control, no increase in symptoms 24–48h later.</div>
                  </div>
                </div>
              </div>

              <div class=\"accordion-item\">
                <h2 class=\"accordion-header\" id=\"h6\"><button class=\"accordion-button collapsed\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#c6\">Optional Weekend — Yoga / Pilates / Mobility</button></h2>
                <div id=\"c6\" class=\"accordion-collapse collapse\" data-bs-parent=\"#planAccordion\">
                  <div class=\"accordion-body\">
                    <p><strong>Purpose:</strong> Recovery, breath, gentle end‑range exposure without lumbar aggravation.</p>
                    <ul>
                      <li><em>Yoga flow (20–40 min):</em> cat‑cow, child’s pose (hip‑hinge variant), low lunge, sphinx/cobra (tolerated), pigeon (gentle), thoracic openers.</li>
                      <li><em>Pilates focus (20–30 min):</em> imprint/neutral drills, dead bug series, side‑lying leg work, swimming prep (prone extension light).</li>
                      <li><em>Mobility:</em> hip flexor, hamstring, glute, adductor 2×30s each; breathing 3–5 min.</li>
                    </ul>
                    <div class=\"small text-secondary\">Skip if pain >3/10 or if prior day caused symptoms ↑. Choose one (yoga or Pilates) based on what leaves your back calmer afterward.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class=\"col-12 col-xl-4\">
          <div class=\"card p-3 mb-3\">
            <h6 class=\"mb-2\">Exercise Library (quick links)</h6>\n            <ul class=\"small m-0\">\n              <!-- Core stability -->\n              <li>Dead bug — <a href=\"https://www.youtube.com/results?search_query=dead+bug+exercise+tutorial\" target=\"_blank\">YouTube</a></li>\n              <li>Bird-dog — <a href=\"https://www.youtube.com/results?search_query=bird+dog+exercise+proper+form\" target=\"_blank\">YouTube</a></li>\n              <li>Front plank — <a href=\"https://www.youtube.com/results?search_query=front+plank+how+to\" target=\"_blank\">YouTube</a></li>\n              <li>Side plank — <a href=\"https://www.youtube.com/results?search_query=side+plank+proper+form\" target=\"_blank\">YouTube</a></li>\n              <li>Pallof press — <a href=\"https://www.youtube.com/watch?v=5_8d8vHgZvU\" target=\"_blank\">YouTube</a></li>\n              <li>Plank with alternating reach — <a href=\"https://www.youtube.com/results?search_query=plank+with+reach+exercise\" target=\"_blank\">YouTube</a></li>\n\n              <!-- Mobility & nerve -->\n              <li>Kneeling hip flexor stretch — <a href=\"https://www.youtube.com/results?search_query=kneeling+hip+flexor+stretch+cueing\" target=\"_blank\">YouTube</a></li>\n              <li>Hamstring stretch (banded or chair) — <a href=\"https://www.youtube.com/results?search_query=hamstring+stretch+banded+seated\" target=\"_blank\">YouTube</a></li>\n              <li>Thoracic rotations (open book) — <a href=\"https://www.youtube.com/results?search_query=open+book+thoracic+rotation+exercise\" target=\"_blank\">YouTube</a></li>\n              <li>Sciatic nerve glides (sliders) — <a href=\"https://www.youtube.com/results?search_query=sciatic+nerve+glide+slider+exercise\" target=\"_blank\">YouTube</a></li>\n              <li>Diaphragmatic breathing — <a href=\"https://www.youtube.com/results?search_query=diaphragmatic+breathing+how+to\" target=\"_blank\">YouTube</a></li>\n\n              <!-- Lower body strength (hip-dominant) -->\n              <li>Glute bridge — <a href=\"https://www.youtube.com/watch?v=OUgsJ8-Vi0E\" target=\"_blank\">YouTube</a></li>\n              <li>Split squat — <a href=\"https://www.youtube.com/watch?v=SGHnCftrZkA\" target=\"_blank\">YouTube</a></li>\n              <li>Dumbbell Romanian deadlift — <a href=\"https://www.youtube.com/results?search_query=dumbbell+romanian+deadlift+form\" target=\"_blank\">YouTube</a></li>\n              <li>Step-ups — <a href=\"https://www.youtube.com/results?search_query=step+up+exercise+proper+form\" target=\"_blank\">YouTube</a></li>\n              <li>Hamstring curl (Swiss ball or machine) — <a href=\"https://www.youtube.com/results?search_query=swiss+ball+hamstring+curl+exercise\" target=\"_blank\">YouTube</a></li>\n              <li>Single-leg RDL — <a href=\"https://www.youtube.com/watch?v=Zfr6wizR8rs\" target=\"_blank\">YouTube</a></li>\n\n              <!-- Power / balance (snowboard prep) -->\n              <li>Lateral hops (soft landings) — <a href=\"https://www.youtube.com/results?search_query=lateral+hops+plyometrics+soft+landing\" target=\"_blank\">YouTube</a></li>\n              <li>Low-amplitude jump & stick — <a href=\"https://www.youtube.com/results?search_query=jump+and+stick+landing+mechanics\" target=\"_blank\">YouTube</a></li>\n              <li>BOSU or pad single-leg balance — <a href=\"https://www.youtube.com/results?search_query=bosu+single+leg+balance+exercise\" target=\"_blank\">YouTube</a></li>\n              <li>Half-kneeling cable/band chop — <a href=\"https://www.youtube.com/results?search_query=half+kneeling+chop+exercise\" target=\"_blank\">YouTube</a></li>\n              <li>Light Russian twists — <a href=\"https://www.youtube.com/results?search_query=russian+twist+light+form\" target=\"_blank\">YouTube</a></li>\n\n              <!-- Weekend yoga / Pilates options -->\n              <li>Cat–cow — <a href=\"https://www.youtube.com/results?search_query=cat+cow+yoga+how+to\" target=\"_blank\">YouTube</a></li>\n              <li>Child’s pose (hip-hinge variant) — <a href=\"https://www.youtube.com/results?search_query=child%27s+pose+hip+hinge+variant\" target=\"_blank\">YouTube</a></li>\n              <li>Low lunge — <a href=\"https://www.youtube.com/results?search_query=low+lunge+yoga+alignment\" target=\"_blank\">YouTube</a></li>\n              <li>Sphinx/Cobra (gentle) — <a href=\"https://www.youtube.com/results?search_query=sphinx+pose+gentle+cobra+yoga\" target=\"_blank\">YouTube</a></li>\n              <li>Pigeon (gentle) — <a href=\"https://www.youtube.com/results?search_query=pigeon+pose+gentle+modification\" target=\"_blank\">YouTube</a></li>\n              <li>Thoracic opener (thread the needle) — <a href=\"https://www.youtube.com/results?search_query=thread+the+needle+thoracic+mobility\" target=\"_blank\">YouTube</a></li>\n              <li>Pilates imprint/neutral — <a href=\"https://www.youtube.com/results?search_query=pilates+imprint+neutral+spine+exercise\" target=\"_blank\">YouTube</a></li>\n              <li>Side-lying leg series — <a href=\"https://www.youtube.com/results?search_query=pilates+side+lying+leg+series\" target=\"_blank\">YouTube</a></li>\n              <li>Prone “swimming” prep — <a href=\"https://www.youtube.com/results?search_query=pilates+swimming+prep+prone\" target=\"_blank\">YouTube</a></li>\n            </ul>
          </div>
          <div class=\"card p-3\">
            <h6 class=\"mb-2\">Attach Packet PDF (optional)</h6>
            <p class=\"small text-secondary mb-2\">Paste a public link to your PDF packet. It will appear below as a button.</p>
            <input id=\"packetUrl\" class=\"form-control mb-2\" placeholder=\"https://.../Snowboard_Rehab_Tracker_Packet.pdf\" />
            <button id=\"savePacket\" class=\"btn btn-outline-info btn-sm\"><i class=\"bi bi-link-45deg me-1\"></i>Save Packet Link</button>
            <div id=\"packetLinkWrap\" class=\"mt-3\"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // --- Utilities ---
    const $$ = sel => document.querySelector(sel);
    const $$$ = sel => [...document.querySelectorAll(sel)];

    const STORAGE_KEY = 'rehab_entries_v1';
    const SETTINGS_KEY = 'rehab_settings_v1';

    function todayISO(){
      const d = new Date();
      const tzoffset = d.getTimezoneOffset()*60000; // minutes to ms
      return new Date(Date.now()-tzoffset).toISOString().slice(0,10);
    }

    function loadEntries(){
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; }
    }
    function saveEntries(entries){ localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); }

    function loadSettings(){
      try { return JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}'); } catch { return {}; }
    }
    function saveSettings(s){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }

    function toNumber(v){ const n = Number(v); return isNaN(n)? null : n; }

    function dedupeAndSort(list){
      // de-dupe by date+type
      const map = new Map();
      list.forEach(e => {
        const key = `${e.date}|${e.sessionType}`;
        map.set(key, e); // last write wins
      });
      const arr = [...map.values()].sort((a,b)=> a.date.localeCompare(b.date));
      return arr;
    }

    function csvEscape(v){ if(v==null) return ''; const s = String(v).replaceAll('"','""'); return `"${s}"`; }

    function toCSV(rows){
      const headers = ["date","sessionType","duration","lb_before","lb_during","lb_after","leg_before","leg_during","leg_after","surface","sit_minutes","completed","notes"];
      const lines = [headers.join(',')];
      rows.forEach(r=>{
        const line = [r.date,r.sessionType,r.duration,r.lb_before,r.lb_during,r.lb_after,r.leg_before,r.leg_during,r.leg_after,r.surface,r.sit_minutes,r.completed,r.notes]
          .map(csvEscape).join(',');
        lines.push(line);
      });
      return lines.join('\n');
    }

    async function fetchCSV(url){
      const res = await fetch(url);
      if(!res.ok) throw new Error('Fetch failed');
      const text = await res.text();
      return parseCSV(text);
    }

    function parseCSV(text){
      const lines = text.split(/\r?\n/).filter(Boolean);
      const headers = lines.shift().split(',').map(h=>h.trim().replace(/^"|"$/g,''));
      const idx = (name)=> headers.indexOf(name);
      const out = [];
      lines.forEach(line=>{
        // naive CSV split (handles quoted with commas by regex)
        const cols = line.match(/("[^"]*("{2}[^"]*)*"|[^,]*)/g)?.filter((_,i)=>true) || [];
        const get = (name)=> {
          const i = idx(name); if(i<0 || i>=cols.length) return '';
          let v = cols[i] || '';
          v = v.replace(/^"|"$/g,'').replace(/""/g,'"');
          return v;
        };
        out.push({
          date: get('date') || get('Date'),
          sessionType: get('sessionType') || get('Session Type'),
          duration: toNumber(get('duration') || get('Duration')),
          lb_before: toNumber(get('lb_before') || get('LB Before')),
          lb_during: toNumber(get('lb_during') || get('LB During')),
          lb_after: toNumber(get('lb_after') || get('LB After')),
          leg_before: toNumber(get('leg_before') || get('Leg Before')),
          leg_during: toNumber(get('leg_during') || get('Leg During')),
          leg_after: toNumber(get('leg_after') || get('Leg After')),
          surface: get('surface') || get('Surface'),
          sit_minutes: toNumber(get('sit_minutes') || get('Sit min') || get('Sitting Minutes')),
          completed: get('completed') || get('Completed'),
          notes: get('notes') || get('Notes'),
        });
      });
      return out.filter(r=>r.date && r.sessionType);
    }

    // --- Routing ---
    function setActive(hash){
      const route = hash || '#/log';
      $$$('.view').forEach(v => v.classList.add('d-none'));
      if(route.startsWith('#/trends')) $$('#view-trends').classList.remove('d-none');
      else if(route.startsWith('#/settings')) $$('#view-settings').classList.remove('d-none');
      else if(route.startsWith('#/data')) $$('#view-data').classList.remove('d-none');
      else if(route.startsWith('#/about')) $$('#view-about').classList.remove('d-none');
      else if(route.startsWith('#/plan')) $$('#view-plan').classList.remove('d-none');
      else $$('#view-log').classList.remove('d-none');
      $$$('#nav .nav-link').forEach(a=> a.classList.toggle('active', a.getAttribute('href')===route));
      if(route.startsWith('#/trends')) renderCharts();
      if(route.startsWith('#/data')) renderTable();
      if(route.startsWith('#/log')) updateQuickStats();
    }

    window.addEventListener('hashchange', ()=> setActive(location.hash));

    // --- Form handling ---
    function formToEntry(){
      return {
        date: $$('#date').value,
        sessionType: $$('#sessionType').value,
        duration: toNumber($$('#duration').value),
        lb_before: toNumber($$('#lbBefore').value),
        lb_during: toNumber($$('#lbDuring').value),
        lb_after: toNumber($$('#lbAfter').value),
        leg_before: toNumber($$('#legBefore').value),
        leg_during: toNumber($$('#legDuring').value),
        leg_after: toNumber($$('#legAfter').value),
        surface: $$('#surface').value,
        sit_minutes: toNumber($$('#sitMinutes').value),
        completed: $$('#completed').value,
        notes: $$('#notes').value?.trim() || ''
      };
    }

    function updateQuickStats(){
      const entries = loadEntries();
      if(!entries.length){ $$('#quickStats').innerText = 'No data yet.'; return; }
      const last = entries[entries.length-1];
      const avg = (arr)=> (arr.length? (arr.reduce((a,b)=>a+(b??0),0)/arr.length).toFixed(1): '—');
      const avgLB = avg(entries.map(e=> e.lb_after ?? 0).filter(v=> v!==null));
      const avgLeg = avg(entries.map(e=> e.leg_after ?? 0).filter(v=> v!==null));
      const avgSit = avg(entries.map(e=> e.sit_minutes ?? 0).filter(v=> v!==null));
      $$('#quickStats').innerHTML = `
        <div><strong>Last:</strong> ${last.date} • ${last.sessionType}</div>
        <div>Avg Back Pain (after): <strong>${avgLB}</strong></div>
        <div>Avg Right‑Leg Symptoms (after): <strong>${avgLeg}</strong></div>
        <div>Avg Sitting Tolerance (min): <strong>${avgSit}</strong></div>
      `;
    }

    // --- Charts ---
    let chartBack, chartLeg, chartSit, chartCompletion;
    function destroyCharts(){ [chartBack, chartLeg, chartSit, chartCompletion].forEach(c=> c && c.destroy()); chartBack=chartLeg=chartSit=chartCompletion=null; }

    function renderCharts(){
      const entries = loadEntries();
      destroyCharts();
      if(!entries.length) return;
      const labels = entries.map(e=> e.date);
      const backAfter = entries.map(e=> e.lb_after ?? null);
      const legAfter = entries.map(e=> e.leg_after ?? null);
      const sit = entries.map(e=> e.sit_minutes ?? null);
      const compMap = {Yes:0, No:0, Modified:0}; entries.forEach(e=> compMap[e.completed??'No'] = (compMap[e.completed??'No']||0)+1);

      chartBack = new Chart($$('#chartBack'), { type:'line', data:{ labels, datasets:[{ label:'Back Pain (after)', data: backAfter }] }});
      chartLeg = new Chart($$('#chartLeg'), { type:'line', data:{ labels, datasets:[{ label:'Leg Symptoms (after)', data: legAfter }] }});
      chartSit = new Chart($$('#chartSit'), { type:'bar', data:{ labels, datasets:[{ label:'Sitting Tolerance (min)', data: sit }] }});
      chartCompletion = new Chart($$('#chartCompletion'), {
        type:'doughnut', data:{ labels:Object.keys(compMap), datasets:[{ data:Object.values(compMap) }] }
      });
    }

    // --- Table ---
    function renderTable(){
      const tbody = $$('#dataTable tbody');
      tbody.innerHTML = '';
      const entries = loadEntries();
      entries.forEach(e=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${e.date}</td><td>${e.sessionType}</td><td>${e.duration??''}</td>
          <td>${e.lb_before??''}</td><td>${e.lb_during??''}</td><td>${e.lb_after??''}</td>
          <td>${e.leg_before??''}</td><td>${e.leg_during??''}</td><td>${e.leg_after??''}</td>
          <td>${e.surface??''}</td><td>${e.sit_minutes??''}</td><td>${e.completed??''}</td>
          <td class="text-wrap" style="max-width:320px">${(e.notes||'')}</td>`;
        tbody.appendChild(tr);
      });
    }

    // --- Init ---
    window.addEventListener('DOMContentLoaded', ()=>{
      // Defaults
      $$('#todayStr').innerText = new Date().toLocaleDateString();
      $$('#date').value = todayISO();

      // Routing
      setActive(location.hash);

      // Handlers
      $$('#logForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        const entry = formToEntry();
        if(!entry.date) return alert('Please select a date');
        const merged = dedupeAndSort([...loadEntries(), entry]);
        saveEntries(merged);
        updateQuickStats();
        renderTable();
        alert('Saved!');
      });

      $$('#exportCsv').addEventListener('click', ()=>{
        const csv = toCSV(loadEntries());
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'rehab_entries.csv'; a.click();
        URL.revokeObjectURL(url);
      });

      $$('#clearAll').addEventListener('click', ()=>{
        if(confirm('Clear all locally stored entries?')){ saveEntries([]); renderTable(); updateQuickStats(); destroyCharts(); alert('Cleared.'); }
      });

      $$('#downloadJson').addEventListener('click', ()=>{
        const data = JSON.stringify(loadEntries(), null, 2);
        const blob = new Blob([data], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'rehab_entries.json'; a.click();
        URL.revokeObjectURL(url);
      });

      $$('#importCsv').addEventListener('click', async ()=>{
        const url = $$('#csvUrl').value.trim();
        if(!url) return alert('Paste a CSV URL.');
        try{
          const rows = await fetchCSV(url);
          const merged = dedupeAndSort([ ...loadEntries(), ...rows ]);
          saveEntries(merged);
          updateQuickStats(); renderTable(); renderCharts();
          alert(`Imported ${rows.length} rows.`);
        }catch(err){ console.error(err); alert('Import failed. Check URL and CORS.'); }
      });

      $$('#resetCsv').addEventListener('click', ()=>{ $$('#csvUrl').value=''; alert('CSV source cleared (no effect on local data).'); });

      const s = loadSettings();
      if(s.pain!=null) $$('#thPain').value = s.pain;
      if(s.sit!=null) $$('#thSit').value = s.sit;
      $$('#saveSettings').addEventListener('click', ()=>{
        saveSettings({ pain: toNumber($$('#thPain').value), sit: toNumber($$('#thSit').value) });
        alert('Settings saved');
      });
      $$('#resetSettings').addEventListener('click', ()=>{
        localStorage.removeItem(SETTINGS_KEY);
        $$('#thPain').value=''; $$('#thSit').value='';
        alert('Settings reset');
      });

      // Packet link persistence
      const packetKey = 'rehab_packet_url_v1';
      const existingPacket = localStorage.getItem(packetKey);
      if(existingPacket){
        $$('#packetUrl') && ($$('#packetUrl').value = existingPacket);
        const btn = document.createElement('a');
        btn.className = 'btn btn-success btn-sm';
        btn.target = '_blank';
        btn.href = existingPacket;
        btn.innerHTML = '<i class="bi bi-file-earmark-pdf me-1"></i>Open Packet PDF';
        $$('#packetLinkWrap') && $$('#packetLinkWrap').appendChild(btn);
      }
      $$('#savePacket') && $$('#savePacket').addEventListener('click', ()=>{
        const url = $$('#packetUrl').value.trim();
        if(!url) return alert('Paste a PDF URL');
        localStorage.setItem(packetKey, url);
        $$('#packetLinkWrap').innerHTML = '';
        const btn = document.createElement('a');
        btn.className = 'btn btn-success btn-sm';
        btn.target = '_blank';
        btn.href = url;
        btn.innerHTML = '<i class="bi bi-file-earmark-pdf me-1"></i>Open Packet PDF';
        $$('#packetLinkWrap').appendChild(btn);
        alert('Packet link saved');
      });
    });
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
